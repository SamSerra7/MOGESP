@model IEnumerable<String>
@{
    ViewData["Title"] = "Primeros Ingresos";
}

<!DOCTYPE html>
<html>

<head>

    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.css">

</head>

<body>

    <br><br>
        <div class="container">
            <div style="width:810px; padding:3px;">
                <div class="col-md-12 col-xs-12 col-sm-12">
                    <center>
                        <h2>Cuadro General</h2>
                    </center>
                </div>
                <br />
                <div class="col-md-12 col-xs-12 col-sm-12 col-lg-12">
                    <hr />
                </div>
                <br />
                <div>
                    <h6>No.Convocatoria</h6>
                    <select class="browser-default custom-select" id="buscarNumConvocatoria">
                        <option value="AA">Todas</option>
                        @foreach (var convocatoria in Model)
                        {
                            <option value="@convocatoria">
                                @convocatoria
                            </option>
                        }
                    </select>
                    <h6>No.Flujo</h6>
                    <select class="browser-default custom-select" id="buscarNumFlujo">
                        <option value="0">Todos</option>
                    </select>
                    


                    <br><br>

                    <h4>Filtros:</h4>

                    <br>

                    <div style="width:200px; float:left;">
                        <h6>Condicion de puesto</h6>
                        <select id="estadoSelectF" class="browser-default custom-select">
                            <option selected value="0">Todos</option>
                            <option value="1">Nombrados</option>
                            <option value="2">Positivos</option>
                            <option value="3">En espera</option>
                            <option value="4">Negativos</option>
                        </select>

                    </div>

                    <div style="width:200px; float:left;">
                        <h6>Puestos</h6>
                        <select id="puestoSelectF" class="browser-default custom-select">
                            <option selected value="0">Todos</option>
                            <option value="1">Investigador 1</option>
                            <option value="2">Agente de protecci&oacute;n</option>
                            <option value="3">Custodio de Detenidos</option>
                            <option value="4">Agente de localizaci&oacute;n</option>
                        </select>

                    </div>




                    <br><br><br><br>
                </div>
                <button class="btn btn-success" id="aplicarFiltros">Aplicar</button>
                <br><br>
            </div>
        </div>
    <div class="table-responsive col-md-12 col-xs-12 col-sm-12" style="text-align: center; overflow-y: auto;">
        <table id="estadoTabla" class="table table-bordered table-responsive table-hover">
            <thead style="align-content: center;">
                <tr style=" background-color: #222;" class="btn-primary">

                    <th scope="col">
                        Nombrados
                    </th>
                    <th scope="col">
                        Positivos en espera
                    </th>
                    <th scope="col">
                        En Espera
                    </th>
                    <th scope="col">
                        Negativos
                    </th>

                </tr>
            </thead>

            <tbody>

                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>

                </tr>

            </tbody>

        </table>

    </div>
    <br><br>

    <!--Tabla Resumen de días-->
        <div class="table-responsive col-md-12 col-xs-12 col-sm-12" style="text-align: center; overflow-y: auto;">
            <table id="tablaDeps" class="table table-striped table-bordered">
                <thead style="align-content: center;">
                    <tr style=" background-color: #222;" class="btn-primary">
                        <th class="centrarTitulos">Gesti&oacute;n Humana - Administraci&oacute;n</th>
                        <th class="centrarTitulos">Antecedentes</th>
                        <th class="centrarTitulos">Transportes</th>
                        <th class="centrarTitulos">Pruebas M&eacute;dicas</th>
                        <th class="centrarTitulos">Toxolog&iacute;a</th>

                    </tr>
                </thead>

                <tr style="background:#f1f1f1"></tr>

            </table>

        </div>

    

    <br><br>
        <div class="container">
            <p>Seleccione las columnas que desea volver visibles</p>

            <label class="checkbox-inline">
                <input type="checkbox" id="ck1" value="1">N&deg;. Concurso
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck2" value="2">Ubicaci&oacute;n
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck3" value="3">N&deg;. C&eacute;dula
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck4" value="4">Nombre
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck5" value="5">Investigador 1
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck6" value="6">Agente de Protecci&oacute;n
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck7" value="7">Custodio de detenidos
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck8" value="8">Agente de localizaci&oacute;n
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck9" value="9">T.Administraci&oacute;n
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck10" value="10">Pruebas Psicol&oacute;gicas-Psicom&eacute;tricas
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck11" value="11">T.Administraci&oacute;n
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck12" value="12">Invest. De Antecedentes
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck13" value="13">T.Administraci&oacute;n
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck14" value="14">Vialidad
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck15" value="15">Fecha Envio a GH Traslado a Nueva Etapa
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck16" value="16">T.Administraci&oacute;n
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck17" value="17">Pruebas M&eacute;dicas
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck18" value="18">T.Administraci&oacute;n
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck19" value="19">Toxicolog&iacute;a
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck20" value="20">Instancia en que perdi&oacute; el Proceso
            </label>
            <label class="checkbox-inline">
                <input type="checkbox" id="ck22" value="22">Fecha Ingreso
            </label>

        </div>
    <br><br>

    <div class="container">
        <button class="btn btn-success" id="exportExcel">Exportar Excel</button>
    </div>

    <!--Tabla Cuadro General-->
    <div class="table-responsive col-md-12 col-xs-12 col-sm-12" style="text-align: center; overflow-y: auto;">
        <table id="tablaPrimerosIngresos" class="table table-striped table-bordered">
            <thead style="align-content: center;">
                <tr style=" background-color: #222;" class="btn-primary">
                    <th class="centrarTitulos">N&deg;. Concurso</th>
                    <th class="centrarTitulos">Ubicaci&oacute;n</th>
                    <th class="centrarTitulos">N&deg;. C&eacute;dula</th>
                    <th class="centrarTitulos">Nombre</th>
                    <th class="centrarTitulos">Investigador 1</th>
                    <th class="centrarTitulos">Agente de Protecci&oacute;n</th>
                    <th class="centrarTitulos">Custodio de detenidos</th>
                    <th class="centrarTitulos">Agente de localizaci&oacute;n</th>
                    <th class="centrarTitulos">
                        Tr&aacute;mite
                        <br>Administraci&oacute;n
                    </th>
                    <th class="centrarTitulos">
                        Pruebas
                        <br>Psicol&oacute;gicas-Psicom&eacute;tricas
                    </th>
                    <th class="centrarTitulos">
                        Tr&aacute;mite
                        <br>Administraci&oacute;n
                    </th>
                    <th class="centrarTitulos">
                        Invest.
                        <br>De Antecedentes
                    </th>
                    <th class="centrarTitulos">
                        Tr&aacute;mite
                        <br>Administraci&oacute;n
                    </th>
                    <th class="centrarTitulos">Vialidad</th>
                    <th class="centrarTitulos">
                        Fecha Envio a GH
                        <br>Traslado a Nueva Etapa
                    </th>
                    <th class="centrarTitulos">
                        Tr&aacute;mite
                        <br>Administraci&oacute;n
                    </th>
                    <th class="centrarTitulos">Pruebas M&eacute;dicas</th>
                    <th class="centrarTitulos">
                        Tr&aacute;mite
                        <br>Administraci&oacute;n
                    </th>
                    <th class="centrarTitulos">Toxicolog&iacute;a</th>
                    <th class="centrarTitulos">
                        Instancia en que
                        <br>Perdi&oacute; el Proceso
                    </th>
                    <th class="centrarTitulos">Condici&oacute;n</th>

                    <th class="centrarTitulos">Fecha Ingreso</th>
                    <th class="centrarTitulos">
                        Cantidad Total
                        <br>D&iacute;as en Tr&aacute;mite
                    </th>

                </tr>
            </thead>

            <tr style="background:#f1f1f1"></tr>

        </table>
        <div>
            <button id="previousBtn" type="button" class="btn btn-dark">&laquo; Previous</button>
            <label id="paginationLabel"></label>
            <button id="nextBtn" type="button" class="btn btn-light">Next &raquo</button>
        </div>

    </div>


</body>


</html>
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap.min.js"></script>
<script>
    var btn_BuscarFLCV = $("#btn_BuscarFLCV");
    var selectFlujos = $("#buscarNumFlujo");
    var selectConvocatoria = $("#buscarNumConvocatoria");
    var tablaPrimerosIngresos = $("#tablaPrimerosIngresos");
    var tablaDeps = $("#tablaDeps");
    var estadoTabla = $("#estadoTabla");

    var paginationLabel = $("#paginationLabel");
    var btnPrevious = $('#previousBtn');
    var btnNext = $('#nextBtn');
    var btnExportExcel = $("#exportExcel");

    var estadoSelectF = $("#estadoSelectF");
    var puestoSelectF = $("#puestoSelectF");

    var contentPaginationLbl = "";
    var actualPage = 0;
    var totalPages = 0;
    var dataP;

    var nombrePI = "";
    var puestos = "N/A";
    var investigador1 = "N/A";
    var agenteDeProteccion = "N/A";
    var custodioDeDetenidos = "N/A";
    var agenteDeLocalizacion = "N/A";

    var estadoVal;
    var puestoVal;
    $("#exportExcel").click(function () {
        exportTableToExcel("tablaPrimerosIngresos",'CuadroGeneralPI');
    });
    $("#aplicarFiltros").click(function () {
        estadoVal = estadoSelectF.val();
        puestoVal = puestoSelectF.val();
        if (estadoVal == 0 & puestoVal == 0) {
            var url2 = "http://localhost:55439/api/cuadroGeneral/listaPI/" + selectConvocatoria.val() + "/" + selectFlujos.val();
            metodoPostMuestraDatos(url2);
        } else if (estadoVal < 0 || puestoVal < 0) {
            alert("El cuadro general seleccionado esta vacio");
        } else if (estadoVal > 4 || puestoVal > 4) {
            alert("El cuadro general seleccionado esta vacio");
        } else {
            
            var url2 = "http://localhost:55439/api/cuadroGeneral/listaPIFiltrado/" + selectConvocatoria.val() + "/" + selectFlujos.val() +
                "/" + estadoVal + "/" + puestoVal;
            
            metodoPostMuestraDatos(url2);
        }
        
        //applyFilters(dataP, 0, dataP.listaCuadroGeneral.length, estadoVal, puestoVal);
        
        
    });
    $('#previousBtn').click(function () {
        
        contentPaginationLbl = paginationLabel.html();
        actualPage = parseInt(contentPaginationLbl[0]);
        totalPages = parseInt(contentPaginationLbl[2]);
        if (actualPage != 1) {
            if (actualPage == 2) {
                btnPrevious.hide();
            }
            if (actualPage == totalPages) {
                btnNext.show();
            }
            actualPage = actualPage - 1;
            paginationLabel.text(actualPage + "/" + totalPages);
            displayTable(dataP, (actualPage * 10) - 10, actualPage*10);
        }
        
    });
    $('#nextBtn').click(function () {
        
        contentPaginationLbl = paginationLabel.html();
        actualPage = parseInt(contentPaginationLbl[0]);
        totalPages = parseInt(contentPaginationLbl[2]);
        
        if (actualPage == 1) {
            btnPrevious.show();
        }
        if (totalPages - actualPage == 1) {
            btnNext.hide();
        }
        actualPage = actualPage + 1;
        paginationLabel.text(actualPage + "/" + totalPages);
        displayTable(dataP, (actualPage * 10) - 10, actualPage * 10);
    });
    function hideDefaultColumns() {
        for (var i = 5; i < 23; i++) {

            if (i != 21) {
                $("#ck" + i).prop('checked', true);
                $('#tablaPrimerosIngresos th:nth-child(' + i + ')').hide();
                $('#tablaPrimerosIngresos td:nth-child(' + i + ')').hide();
                
            }
        }
    }
    $(document).ready(function () {

        hideDefaultColumns();
        btnNext.hide();
        btnPrevious.hide();
        paginationLabel.hide();
        btnExportExcel.hide();
    });
    $('label.checkbox-inline').click(function () {
        var headColumn = $('#tablaPrimerosIngresos th:nth-child(' + $(this).children().val() + ')');
        var column = $('#tablaPrimerosIngresos td:nth-child(' + $(this).children().val() + ')');



        //Visibilidad de columnas


        if (column.css('display') == 'none') {
            headColumn.show();
            column.show();
        } else {
            headColumn.hide();
            column.hide();
        }

       
    });
    
    function displayTable(data, range1, range2) {
        tablaPrimerosIngresos.find("tr:gt(0)").remove();
        tablaDeps.find("tr:gt(0)").remove();
        estadoTabla.find("tr:gt(0)").remove();
        if (range1 > range2) {
            var temp = range2;
            range2 = range1;
            range1 = temp;
        }
        for (var key = range1; key < range2; key++) {
            puestos = "";
            if (data.listaCuadroGeneral.hasOwnProperty(key)) {
                nombrePI = "" + data.listaCuadroGeneral[key].nombrePI + " " + data.listaCuadroGeneral[key].primerApellido + " " + data.listaCuadroGeneral[key].segundoApellido;
                investigador1 = "N/A";
                agenteDeProteccion = "N/A";
                custodioDeDetenidos = "N/A";
                agenteDeLocalizacion = "N/A";
                for (puestoKey in data.listaCuadroGeneral[key].puestosAplica) {
                    
                    puestos = puestos + data.listaCuadroGeneral[key].puestosAplica[puestoKey].nombre + ", ";
                    if (data.listaCuadroGeneral[key].puestosAplica[puestoKey].nombre == "Investigador 1") {
                        investigador1 = data.listaCuadroGeneral[key].puestosAplica[puestoKey].condicion
                    } else if (data.listaCuadroGeneral[key].puestosAplica[puestoKey].nombre == "Agente de Proteccion") {
                        agenteDeProteccion = data.listaCuadroGeneral[key].puestosAplica[puestoKey].condicion
                    } else if (data.listaCuadroGeneral[key].puestosAplica[puestoKey].nombre == "Custodio de detenidos") {
                        custodioDeDetenidos = data.listaCuadroGeneral[key].puestosAplica[puestoKey].condicion
                    } else if (data.listaCuadroGeneral[key].puestosAplica[puestoKey].nombre == "Agente de localizacion") {
                        agenteDeLocalizacion = data.listaCuadroGeneral[key].puestosAplica[puestoKey].condicion
                    }

                    //console.log(data[key].puestosAplica[puestoKey].idPuesto)
                }
                $(
                    '<tr style="background:#f1f1f1" id="tupla' + key + '">' + '</tr>'
                )
                    .appendTo(tablaPrimerosIngresos);
                $(
                    '<td>' + data.listaCuadroGeneral[key].numeroConvocatoria + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].numeroFlujo + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].numeroCedula + '</td>' +
                    '<td>' + nombrePI + '</td>' +
                    '<td>' + investigador1 + '</td>' +
                    '<td>' + agenteDeProteccion + '</td>' +
                    '<td>' + custodioDeDetenidos + '</td>' +
                    '<td>' + agenteDeLocalizacion + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].cantidadDiasAdminPruebasGH + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].cantidadDiasPruebasGH + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].cantidadDiasAdminAntecedentes + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].cantidadDiasAntecedentes + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].cantidadDiasAdminVialidad + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].cantidadDiasVialidad + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].fechaEnvioGHTraslado + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].cantidadDiasAdminPruebasMedicas + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].cantidadDiasPruebasMedicas + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].cantidadDiasAdminToxicologia + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].cantidadDiasToxicologia + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].instanciaPerdioProceso + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].condicion + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].fechaIngreso + '</td>' +
                    '<td>' + data.listaCuadroGeneral[key].cantidadDiasTotalesTramite + '</td>'


                )
                    .appendTo("#tupla" + key);
                

            }


        }
        $('<tr style="background:#f1f1f1" id="tuplaDeps">' + '</tr>').appendTo(tablaDeps);
        $(
            '<td>' + data.cantidadPruebasGH + '</td>' +
            '<td>' + data.cantidadAntecedentes + '</td>' +
            '<td>' + data.cantidadVialidad + '</td>' +
            '<td>' + data.cantidadPruebasMedicas + '</td>' +
            '<td>' + data.cantidadToxicologia + '</td>'
        )
            .appendTo("#tuplaDeps");
        $('<tr style="background:#f1f1f1" id="tuplaEst">' + '</tr>').appendTo(estadoTabla);
        $(
            '<td>' + data.cantidadNombrados + '</td>' +
            '<td>' + data.cantidadPositivosEnEspera + '</td>' +
            '<td>' + data.cantidadPendientes + '</td>' +
            '<td>' + data.cantidadNegativos + '</td>'
        )
            .appendTo("#tuplaEst");

        btnExportExcel.show();
        hideDefaultColumns();
    }
    function metodoPostMuestraDatos(url2) {
        $.post(url2, null, function (data) {
            dataP = data;
            if (data.listaCuadroGeneral.length === 0) {
                alert("El cuadro general seleccionado esta vacio");
            } else {
                totalPages = Math.ceil(data.listaCuadroGeneral.length / 10);
                if (totalPages > 1) {
                    btnNext.show();
                    btnPrevious.show();
                    paginationLabel.text(1 + "/" + totalPages);
                    paginationLabel.show();
                    displayTable(data, 0, 10);
                } else {
                    displayTable(data, 0, data.listaCuadroGeneral.length);
                    paginationLabel.text(1 + "/" + 1);
                    paginationLabel.hide();
                    btnNext.hide();
                    btnPrevious.hide();
                }


                //btn_BuscarFLCV.prop("disabled", false);
            }
            //console.log("It works " + this.value)
        });
    }
    
    $("#buscarNumConvocatoria").on('change', function () {
        selectFlujos.empty();

        if (this.value != "") {
            if (this.value == "AA") {

                $(
                    '<option value="0">Todos</option>'
                ).appendTo(selectFlujos);

            } else {
                var url = "http://localhost:55439/api/cuadroGeneral/" + this.value;

                $.post(url, null, function (data) {

                    if (data.listaCuadroGeneral.length === 0) {
                        alert("La convocatoria seleccionada no tiene flujos");
                    } else {
                        var size = 0;
                        for (key in data.listaCuadroGeneral) {
                            if (data.listaCuadroGeneral.hasOwnProperty(key)) {

                                $(
                                    '<option value="' + data[size] + '">' +
                                    data[size] +
                                    '</option>'
                                )
                                    .appendTo(selectFlujos);
                                size = size + 1;

                            }


                        }
                        $(
                            '<option value="0">Todos</option>'
                        )
                            .appendTo(selectFlujos);
                        //btn_BuscarFLCV.prop("disabled", false);
                    }
                    //console.log("It works " + this.value)
                });
            }

        }

    });
    function exportTableToExcel(tableID, filename) {
        var downloadLink;
        var dataType = 'application/vnd.ms-excel';
        var tableSelect = document.getElementById(tableID);
        var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');

        // Specify file name
        filename = filename ? filename + '.xls' : 'excel_data.xls';

        // Create download link element
        downloadLink = document.createElement("a");

        document.body.appendChild(downloadLink);

        if (navigator.msSaveOrOpenBlob) {
            var blob = new Blob(['\ufeff', tableHTML], {
                type: dataType
            });
            navigator.msSaveOrOpenBlob(blob, filename);
        } else {
            // Create a link to the file
            downloadLink.href = 'data:' + dataType + ', ' + tableHTML;

            // Setting the file name
            downloadLink.download = filename;

            //triggering the function
            downloadLink.click();
        }
    }
</script>